---
- name: "Large + 20"
  hosts: all
  strategy: free
  gather_facts: false

  tasks:

  - name: "Install curl"
    when: inventory_hostname in groups['clients']
    become: yes
    apt:
      name: curl
      update_cache: yes
      cache_valid_time: 3600

  - name: install sar
    when: inventory_hostname in groups['clients']
    become: yes
    apt:
      name: sysstat
      update_cache: yes
      cache_valid_time: 3600

  - name: "start monitroing"
    when: inventory_hostname in groups['clients']
    shell: 'sar -n DEV 1 200 | sed "s/^/`date +%s` {{ inventory_hostname }} /" | grep "wlan0" | nc -q0 192.168.178.40 5000'
    #shell: 'sar -n DEV 1 200 | sed "s/^/`date` raspberry-AC /" | grep "wlan0" | nc -q0 192.168.178.40 5000'
    async: 300
    poll: 0

  - name: "start monitroing"
    when: inventory_hostname in groups['fileserver']
    shell: 'sar -n DEV 1 200 | sed "s/^/`date +%s` fileserver /" | grep "eth0" | nc 192.168.178.40 5000'
    #shell: 'sar -n DEV 1 200 | sed "s/^/`date` raspberry-AC /" | grep "wlan0" | nc 192.168.178.40 5000'
    async: 300
    poll: 0

  - import_tasks: get_random.yml

  - name: "Download iso"
    when: inventory_hostname in groups['clients2']
    get_url:
      url: 'http://192.168.189.5:8888/files/test.mp4?token=123'
      dest: /home/pi/
      mode: 0755
      owner: pi
    async: 240
    poll: 0

  - name: "Wait for 2 min"
    when: inventory_hostname in groups['clients1']
    wait_for:
      timeout: 120

  - name: "Download website 20 times"
    when: inventory_hostname in groups['clients1']
    get_url:
      url: 'http://192.168.189.5:8888/files/upload.html?token=123'
      dest: /home/pi/
      mode: 0755
      owner: pi
    with_sequence: count=20
...
